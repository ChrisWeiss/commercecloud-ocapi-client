/* * *  *  * *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  * */
/* Copyright (c) 2017 Mobify Research & Development Inc. All rights reserved. */
/* * *  *  * *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  * */

/**
 * Shop API
 * No description provided (generated by Swagger Codegen https://github.com/swagger-api/swagger-codegen)
 *
 * OpenAPI spec version: 17.8
 *
 *
 * NOTE: This class is auto generated by the swagger code generator program.
 * https://github.com/swagger-api/swagger-codegen.git
 * Do not edit the class manually.
 *
 */
import expect from 'expect.js'
import ShopApi from '../../../src/index'
import Order from '../../../src/models/order'
import * as dataSamples from '../../samples'

import {clientId, proxyUrl, baseUrl} from '../../config.json'
import * as utils from '../../utils'

let instance
let client
let newCustomer

before(() => {
    client = new ShopApi.ApiClient({
        basePath: `${baseUrl}`,
        defaultHeaders: {'x-dw-client-id': clientId}
    })
})

beforeEach(() => {
    return utils.getGuestUserAuth(client)
        .then((customer) => {
            newCustomer = customer
            return Promise.resolve()
        })
})

afterEach(() => utils.clearUserAuth(client))

const getProperty = (object, getter, property) => {
    // Use getter method if present; otherwise, get the property directly.
    if (typeof object[getter] === 'function') { return object[getter]() } else { return object[property] }
}

const setProperty = (object, setter, property, value) => {
    // Use setter method if present; otherwise, set the property directly.
    if (typeof object[setter] === 'function') { object[setter](value) } else { object[property] = value }
}

describe('workflows', () => {
    describe('guest checkout e2e', () => {
        it('should be able to complete checkout flow successfully', () => {
            const basketApi = new ShopApi.BasketsApi(client)
            const opdersApi = new ShopApi.OrdersApi(client)

            return basketApi.postBaskets() // Get new basket
                .then((basket) => {
                    // Add product to basket
                    return basketApi.postBasketsByIDItems(
                        basket.basket_id,
                        [{
                          product_id : '008884303989',
                          quantity : 1
                        }]
                    )
                })
                .then((basket) => {
                    // Add billing address to the basket
                    return basketApi.putBasketsByIDBillingAddress(basket.basket_id, {
                        useAsShipping: true,
                        body: dataSamples.validOrderAddress
                    })
                })
                .then((basket) => {
                    // Add billing address to the basket
                    return basketApi.patchBasketsByIDShipmentsByID(basket.basket_id, 'me', {
                        shipping_method: {
                            id: 'standardshipping'
                        }
                    })
                })
                .then((basket) => {
                    const requestObj = dataSamples.validCustomerPaymentInstrumentRequest
                    requestObj.amount = basket.order_total

                    // Add payment information to the basket
                    return basketApi.postBasketsByIDPaymentInstruments(basket.basket_id, requestObj)
                })
                .then((basket) => {
                    // Add payment information to the basket
                    return opdersApi.postOrders(basket)
                })
                .then((order) => {
                    console.log(`Order: ${order.order_no} ('${order.confirmation_status}')`)

                    expect(order).to.be.an('object')
                })
        })
    })
})
